{% extends "base.html" %}

{% block head %}
<style>
    /* Challenge list styles */
    .challenge-list {
        margin-top: 20px;
    }

    .challenge-item {
        transition: all 0.3s ease;
        margin-bottom: 15px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .challenge-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .challenge-completed {
        background-color: rgba(87, 167, 115, 0.1);
    }

    .challenge-deleted {
        background-color: rgba(215, 100, 100, 0.1);
    }

    [data-bs-theme="dark"] .challenge-completed {
        background-color: rgba(0, 173, 181, 0.1);
    }

    [data-bs-theme="dark"] .challenge-deleted {
        background-color: rgba(238, 82, 83, 0.1);
    }

    .challenge-title {
        font-weight: 700;
        font-family: 'McLaren', sans-serif;
    }

    .challenge-meta {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .challenge-actions {
        position: absolute;
        right: 15px;
        top: 15px;
    }

    .challenge-actions .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 8px;
        margin-left: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .challenge-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .challenge-participants {
        margin-top: 10px;
    }

    .challenge-participant {
        background-color: #e9ecef;
        color: #495057;
        border-radius: 50px;
        padding: 3px 12px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-right: 5px;
        margin-bottom: 5px;
        display: inline-block;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    [data-bs-theme="dark"] .challenge-participant {
        background-color: #343a40;
        color: #e9ecef;
    }

    .modal-backdrop {
        opacity: 0.7;
    }

    .action-icon {
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-icon:hover {
        transform: scale(1.2);
    }

    /* Filters */
    .filters {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 10px;
    }

    .filter-btn {
        border-radius: 50px;
        padding: 0.3rem 0.8rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .filter-btn:hover, .filter-btn.active {
        background-color: var(--primary);
        color: white;
    }

    /* Custom participant checkbox list */
    .participant-list {
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 10px;
        margin-top: 5px;
        background-color: #f8f9fa;
    }

    [data-bs-theme="dark"] .participant-list {
        background-color: #2b3035;
        border-color: #495057;
    }

    .participant-item {
        display: block;
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 5px;
        transition: background-color 0.2s;
    }

    .participant-item:hover {
        background-color: var(--primary-light);
    }

    .participant-item input[type="checkbox"] {
        margin-right: 8px;
    }

    /* Progress bar */
    .challenge-progress {
        height: 8px;
        margin-top: 10px;
        border-radius: 4px;
        background-color: #e9ecef;
        overflow: hidden;
    }

    .challenge-progress-bar {
        height: 100%;
        border-radius: 4px;
        background: var(--primary-gradient);
    }

    /* Status badges */
    .badge-active {
        background-color: #57A773;
        color: white;
    }

    .badge-completed {
        background-color: #4682B4;
        color: white;
    }

    .badge-deleted {
        background-color: #D76464;
        color: white;
    }

    /* Tab styling */
    .card-header-tabs {
        margin-right: 0;
        margin-bottom: -1px;
        margin-left: 0;
    }

    .nav-tabs .nav-link {
        border: none;
        margin-bottom: 0;
        border-radius: 0;
        transition: all 0.3s ease;
        font-weight: 600;
        padding: 10px 20px;
        background-color: rgba(255, 255, 255, 0.8);
    }

    .nav-tabs .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.9);
        transform: translateY(-3px);
    }

    .nav-tabs .nav-link.active {
        background-color: #fff;
        color: var(--primary) !important;
        border-top: 3px solid var(--primary);
        border-bottom: none;
        position: relative;
    }

    [data-bs-theme="dark"] .nav-tabs .nav-link {
        background-color: rgba(57, 62, 70, 0.8);
        color: #eeeeee !important;
    }

    [data-bs-theme="dark"] .nav-tabs .nav-link:hover {
        background-color: rgba(57, 62, 70, 0.9);
    }

    [data-bs-theme="dark"] .nav-tabs .nav-link.active {
        background-color: #393E46;
        color: #00ADB5 !important;
        border-top: 3px solid #00ADB5;
    }

    .tab-content {
        padding-top: 1rem;
    }

    /* Empty state styles */
    .empty-state {
        text-align: center;
        padding: 30px 0;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.7;
    }

    .empty-state h4 {
        font-weight: 600;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1>
                <i class="fas fa-trophy me-2"></i>
                Challenges
            </h1>
            <p class="lead">Create and participate in challenges with other users</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <ul class="nav nav-tabs card-header-tabs" id="challengeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-dark" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-tab-pane" type="button" role="tab" aria-controls="active-tab-pane" aria-selected="true">
                                <i class="fas fa-bolt me-1"></i> Active Challenges
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-dark" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed-tab-pane" type="button" role="tab" aria-controls="completed-tab-pane" aria-selected="false">
                                <i class="fas fa-check-circle me-1"></i> Completed
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-dark" id="deleted-tab" data-bs-toggle="tab" data-bs-target="#deleted-tab-pane" type="button" role="tab" aria-controls="deleted-tab-pane" aria-selected="false">
                                <i class="fas fa-trash-alt me-1"></i> Deleted
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-dark" id="add-challenge-tab" data-bs-toggle="tab" data-bs-target="#add-challenge-tab-pane" type="button" role="tab" aria-controls="add-challenge-tab-pane" aria-selected="false">
                                <i class="fas fa-plus-circle me-1"></i> Create Challenge
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="challengeTabsContent">
                        <!-- Active Challenges Tab -->
                        <div class="tab-pane fade show active" id="active-tab-pane" role="tabpanel" aria-labelledby="active-tab" tabindex="0">
                            <div class="challenge-list">
                                {% if active_challenges %}
                                    {% for challenge in active_challenges %}
                                        <div class="card challenge-item position-relative" data-challenge-id="{{ challenge.id }}">
                                            <div class="card-body">
                                                <div class="d-flex">
                                                    <div>
                                                        <h5 class="challenge-title mb-1">{{ challenge.title }}</h5>
                                                        <div class="challenge-meta">
                                                            <span class="me-3">
                                                                <i class="fas fa-calendar-alt me-1"></i>
                                                                Started: {{ challenge.start_date.strftime('%Y-%m-%d %H:%M') }}
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-hourglass-half me-1"></i>
                                                                {% if challenge.end_date %}
                                                                    Ends: {{ challenge.end_date.strftime('%Y-%m-%d %H:%M') }}
                                                                {% else %}
                                                                    No end date
                                                                {% endif %}
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-user me-1"></i>
                                                                Created by {{ challenge.creator.username }}
                                                            </span>
                                                            <span>
                                                                <i class="fas fa-users me-1"></i>
                                                                {{ challenge.participants|length }} participants
                                                            </span>
                                                        </div>
                                                        {% if challenge.description %}
                                                            <p class="my-2">{{ challenge.description|truncate(100) }}</p>
                                                        {% endif %}
                                                        {% if challenge.participants %}
                                                            <div class="challenge-participants">
                                                                {% for user in challenge.participants %}
                                                                    <span class="challenge-participant">
                                                                        <i class="fas fa-user-circle me-1"></i>
                                                                        {{ user.username }}
                                                                    </span>
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="challenge-actions">
                                                    <button class="btn btn-sm btn-outline-primary me-1 view-challenge-btn"
                                                            data-challenge-id="{{ challenge.id }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#viewChallengeModal">
                                                        <i class="fas fa-eye"></i>
                                                    </button>

                                                    {% if challenge.creator_id == current_user.id %}
                                                        <button class="btn btn-sm btn-outline-secondary me-1 edit-challenge-btn"
                                                                data-challenge-id="{{ challenge.id }}"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#editChallengeModal">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success me-1 complete-challenge-btn"
                                                                data-challenge-id="{{ challenge.id }}"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#completeChallengeModal">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger delete-challenge-btn"
                                                                data-challenge-id="{{ challenge.id }}"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#deleteChallengeModal">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    {% else %}
                                                        {% if current_user in challenge.participants %}
                                                            <form method="POST" action="{{ url_for('challenge.leave_challenge', challenge_id=challenge.id) }}" class="d-inline">
                                                                <button type="submit" class="btn btn-sm btn-outline-warning">
                                                                    <i class="fas fa-sign-out-alt"></i>
                                                                </button>
                                                            </form>
                                                        {% else %}
                                                            <form method="POST" action="{{ url_for('challenge.join_challenge', challenge_id=challenge.id) }}" class="d-inline">
                                                                <button type="submit" class="btn btn-sm btn-outline-success">
                                                                    <i class="fas fa-sign-in-alt"></i>
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-trophy text-muted"></i>
                                        <h4>No active challenges</h4>
                                        <p>Create a new challenge or join an existing one!</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Completed Challenges Tab -->
                        <div class="tab-pane fade" id="completed-tab-pane" role="tabpanel" aria-labelledby="completed-tab" tabindex="0">
                            <div class="challenge-list">
                                {% if completed_challenges %}
                                    {% for challenge in completed_challenges %}
                                        <div class="card challenge-item challenge-completed position-relative" data-challenge-id="{{ challenge.id }}">
                                            <div class="card-body">
                                                <span class="badge rounded-pill badge-completed position-absolute" style="top: 15px; right: 15px;">Completed</span>
                                                <div class="d-flex">
                                                    <div>
                                                        <h5 class="challenge-title mb-1">{{ challenge.title }}</h5>
                                                        <div class="challenge-meta">
                                                            <span class="me-3">
                                                                <i class="fas fa-calendar-alt me-1"></i>
                                                                Started: {{ challenge.start_date.strftime('%Y-%m-%d %H:%M') }}
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-clock me-1"></i>
                                                                Completed: {{ challenge.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-user me-1"></i>
                                                                Created by {{ challenge.creator.username }}
                                                            </span>
                                                            <span>
                                                                <i class="fas fa-users me-1"></i>
                                                                {{ challenge.participants|length }} participants
                                                            </span>
                                                        </div>
                                                        {% if challenge.description %}
                                                            <p class="my-2">{{ challenge.description|truncate(100) }}</p>
                                                        {% endif %}
                                                        {% if challenge.participants %}
                                                            <div class="challenge-participants">
                                                                {% for user in challenge.participants %}
                                                                    <span class="challenge-participant">
                                                                        <i class="fas fa-user-circle me-1"></i>
                                                                        {{ user.username }}
                                                                    </span>
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="challenge-actions">
                                                    <button class="btn btn-sm btn-outline-primary me-1 view-challenge-btn"
                                                            data-challenge-id="{{ challenge.id }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#viewChallengeModal">
                                                        <i class="fas fa-eye"></i>
                                                    </button>

                                                    {% if challenge.creator_id == current_user.id %}
                                                        <form method="POST" action="{{ url_for('challenge.reactivate_challenge', challenge_id=challenge.id) }}" class="d-inline">
                                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-redo-alt"></i>
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-check-circle text-muted"></i>
                                        <h4>No completed challenges</h4>
                                        <p>Completed challenges will appear here</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Deleted Challenges Tab -->
                        <div class="tab-pane fade" id="deleted-tab-pane" role="tabpanel" aria-labelledby="deleted-tab" tabindex="0">
                            <div class="challenge-list">
                                {% if deleted_challenges %}
                                    {% for challenge in deleted_challenges %}
                                        <div class="card challenge-item challenge-deleted position-relative" data-challenge-id="{{ challenge.id }}">
                                            <div class="card-body">
                                                <span class="badge rounded-pill badge-deleted position-absolute" style="top: 15px; right: 15px;">Deleted</span>
                                                <div class="d-flex">
                                                    <div>
                                                        <h5 class="challenge-title mb-1">{{ challenge.title }}</h5>
                                                        <div class="challenge-meta">
                                                            <span class="me-3">
                                                                <i class="fas fa-calendar-alt me-1"></i>
                                                                Started: {{ challenge.start_date.strftime('%Y-%m-%d %H:%M') }}
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-trash-alt me-1"></i>
                                                                Deleted: {{ challenge.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                                            </span>
                                                            <span>
                                                                <i class="fas fa-user me-1"></i>
                                                                Created by {{ challenge.creator.username }}
                                                            </span>
                                                        </div>
                                                        {% if challenge.description %}
                                                            <p class="my-2">{{ challenge.description|truncate(100) }}</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="challenge-actions">
                                                    <button class="btn btn-sm btn-outline-primary me-1 view-challenge-btn"
                                                            data-challenge-id="{{ challenge.id }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#viewChallengeModal">
                                                        <i class="fas fa-eye"></i>
                                                    </button>

                                                    {% if challenge.creator_id == current_user.id %}
                                                        <form method="POST" action="{{ url_for('challenge.reactivate_challenge', challenge_id=challenge.id) }}" class="d-inline">
                                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-redo-alt"></i>
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-trash-alt text-muted"></i>
                                        <h4>No deleted challenges</h4>
                                        <p>Deleted challenges will appear here</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Add New Challenge Tab -->
                        <div class="tab-pane fade" id="add-challenge-tab-pane" role="tabpanel" aria-labelledby="add-challenge-tab" tabindex="0">
                            <h4 class="mb-4">
                                <i class="fas fa-plus-circle me-2"></i>
                                Create a New Challenge
                            </h4>
                            <form id="newChallengeForm" method="POST" action="{{ url_for('challenge.create_challenge') }}">
                                {{ form.hidden_tag() }}
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        {{ form.title.label(class="form-label") }}
                                        {{ form.title(class="form-control", placeholder="Enter challenge title") }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.start_date.label(class="form-label") }}
                                        {{ form.start_date(class="form-control", type="datetime-local") }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.end_date.label(class="form-label") }}
                                        {{ form.end_date(class="form-control", type="datetime-local") }}
                                        <small class="form-text text-muted">Optional. Leave blank for challenges with no end date.</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        {{ form.description.label(class="form-label") }}
                                        {{ form.description(class="form-control", rows="3", placeholder="Enter challenge description") }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        {{ form.participants.label(class="form-label") }}
                                        <div class="participant-list">
                                            {% for value, label in form.participants.choices %}
                                            <label class="participant-item">
                                                <input type="checkbox" name="participants" value="{{ value }}"> {{ label }}
                                            </label>
                                            {% endfor %}
                                        </div>
                                        <small class="form-text text-muted">You will be automatically added as a participant.</small>
                                    </div>
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    {{ form.submit(class="btn btn-primary") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Challenge Modal -->
<div class="modal fade" id="viewChallengeModal" tabindex="-1" aria-labelledby="viewChallengeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewChallengeModalLabel">
                    <i class="fas fa-trophy me-2"></i>
                    <span id="viewChallengeTitle">Challenge Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <h5>Description</h5>
                            <p id="viewChallengeDescription" class="border p-3 rounded bg-light">No description provided.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Details</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Status:</strong> <span id="viewChallengeStatus"></span></p>
                                <p><strong>Start Date:</strong> <span id="viewChallengeStartDate"></span></p>
                                <p><strong>End Date:</strong> <span id="viewChallengeEndDate"></span></p>
                                <p><strong>Created By:</strong> <span id="viewChallengeCreator"></span></p>
                                <p><strong>Created On:</strong> <span id="viewChallengeCreatedAt"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <h5>Participants</h5>
                    <div id="viewChallengeParticipants" class="p-3 border rounded">
                        No participants.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="viewChallengeActions">
                    <!-- Action buttons will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Challenge Modal -->
<div class="modal fade" id="editChallengeModal" tabindex="-1" aria-labelledby="editChallengeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editChallengeModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    Edit Challenge
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editChallengeForm" method="POST">
                    {{ form.hidden_tag() }}
                    <div class="row">
                        <div class="col-12 mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control", id="editChallengeTitle") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.start_date.label(class="form-label") }}
                            {{ form.start_date(class="form-control", id="editChallengeStartDate", type="datetime-local") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.end_date.label(class="form-label") }}
                            {{ form.end_date(class="form-control", id="editChallengeEndDate", type="datetime-local") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-select", id="editChallengeStatus") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", id="editChallengeDescription", rows="3") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            {{ form.participants.label(class="form-label") }}
                            <div class="participant-list" id="editChallengeParticipants">
                                {% for value, label in form.participants.choices %}
                                <label class="participant-item">
                                    <input type="checkbox" name="participants" value="{{ value }}" class="edit-participant-checkbox"> {{ label }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateChallengeBtn">
                    <i class="fas fa-save me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Challenge Modal -->
<div class="modal fade" id="deleteChallengeModal" tabindex="-1" aria-labelledby="deleteChallengeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteChallengeModalLabel">
                    <i class="fas fa-trash-alt me-2"></i>
                    Delete Challenge
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this challenge?</p>
                <p><strong>Title:</strong> <span id="deleteChallengeTitle"></span></p>
                <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> This will mark the challenge as deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteChallengeForm" method="POST">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Complete Challenge Modal -->
<div class="modal fade" id="completeChallengeModal" tabindex="-1" aria-labelledby="completeChallengeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeChallengeModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    Complete Challenge
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to mark this challenge as completed?</p>
                <p><strong>Title:</strong> <span id="completeChallengeTitle"></span></p>
                <p class="text-success"><i class="fas fa-info-circle me-2"></i> This will move the challenge to the Completed tab.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="completeChallengeForm" method="POST">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle me-1"></i> Complete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // View Challenge Modal
        const viewChallengeButtons = document.querySelectorAll('.view-challenge-btn');
        const viewChallengeModal = document.getElementById('viewChallengeModal');

        viewChallengeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const challengeId = this.getAttribute('data-challenge-id');
                fetch(`/challenges/${challengeId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Fill modal with challenge data
                        document.getElementById('viewChallengeTitle').textContent = data.title;
                        document.getElementById('viewChallengeDescription').textContent = data.description || 'No description provided.';

                        // Set status with badge
                        let statusText = '';
                        let statusClass = '';
                        switch(data.status) {
                            case 'active':
                                statusText = 'Active';
                                statusClass = 'badge-active';
                                break;
                            case 'completed':
                                statusText = 'Completed';
                                statusClass = 'badge-completed';
                                break;
                            case 'deleted':
                                statusText = 'Deleted';
                                statusClass = 'badge-deleted';
                                break;
                        }
                        document.getElementById('viewChallengeStatus').innerHTML = `<span class="badge rounded-pill ${statusClass}">${statusText}</span>`;

                        // Set dates
                        document.getElementById('viewChallengeStartDate').textContent = new Date(data.start_date).toLocaleString();
                        document.getElementById('viewChallengeEndDate').textContent = data.end_date ? new Date(data.end_date).toLocaleString() : 'No end date';
                        document.getElementById('viewChallengeCreator').textContent = data.creator_name;
                        document.getElementById('viewChallengeCreatedAt').textContent = new Date(data.created_at).toLocaleString();

                        // Set participants
                        const participantsContainer = document.getElementById('viewChallengeParticipants');
                        if (data.participants && data.participants.length > 0) {
                            participantsContainer.innerHTML = '';
                            data.participants.forEach(participant => {
                                const span = document.createElement('span');
                                span.className = 'challenge-participant';
                                span.innerHTML = `<i class="fas fa-user-circle me-1"></i> ${participant.username}`;
                                participantsContainer.appendChild(span);
                                participantsContainer.appendChild(document.createTextNode(' '));
                            });
                        } else {
                            participantsContainer.textContent = 'No participants.';
                        }

                        // Set action buttons based on status and user role
                        const actionsContainer = document.getElementById('viewChallengeActions');
                        actionsContainer.innerHTML = '';

                        const currentUserId = {{ current_user.id }};
                        const isCreator = data.creator_id === currentUserId;
                        const isParticipant = data.participants.some(p => p.id === currentUserId);

                        if (data.status === 'active') {
                            if (isCreator) {
                                // Creator actions for active challenge
                                const editButton = document.createElement('button');
                                editButton.className = 'btn btn-primary me-2';
                                editButton.innerHTML = '<i class="fas fa-edit me-1"></i> Edit';
                                editButton.setAttribute('data-bs-toggle', 'modal');
                                editButton.setAttribute('data-bs-target', '#editChallengeModal');
                                editButton.setAttribute('data-challenge-id', data.id);
                                actionsContainer.appendChild(editButton);

                                const completeButton = document.createElement('button');
                                completeButton.className = 'btn btn-success me-2';
                                completeButton.innerHTML = '<i class="fas fa-check-circle me-1"></i> Complete';
                                completeButton.setAttribute('data-bs-toggle', 'modal');
                                completeButton.setAttribute('data-bs-target', '#completeChallengeModal');
                                completeButton.setAttribute('data-challenge-id', data.id);
                                actionsContainer.appendChild(completeButton);

                                const deleteButton = document.createElement('button');
                                deleteButton.className = 'btn btn-danger';
                                deleteButton.innerHTML = '<i class="fas fa-trash-alt me-1"></i> Delete';
                                deleteButton.setAttribute('data-bs-toggle', 'modal');
                                deleteButton.setAttribute('data-bs-target', '#deleteChallengeModal');
                                deleteButton.setAttribute('data-challenge-id', data.id);
                                actionsContainer.appendChild(deleteButton);
                            } else {
                                // Participant or non-participant actions
                                if (isParticipant) {
                                    const leaveForm = document.createElement('form');
                                    leaveForm.method = 'POST';
                                    leaveForm.action = `/challenges/${data.id}/leave`;

                                    const leaveButton = document.createElement('button');
                                    leaveButton.type = 'submit';
                                    leaveButton.className = 'btn btn-warning';
                                    leaveButton.innerHTML = '<i class="fas fa-sign-out-alt me-1"></i> Leave Challenge';

                                    leaveForm.appendChild(leaveButton);
                                    actionsContainer.appendChild(leaveForm);
                                } else {
                                    const joinForm = document.createElement('form');
                                    joinForm.method = 'POST';
                                    joinForm.action = `/challenges/${data.id}/join`;

                                    const joinButton = document.createElement('button');
                                    joinButton.type = 'submit';
                                    joinButton.className = 'btn btn-success';
                                    joinButton.innerHTML = '<i class="fas fa-sign-in-alt me-1"></i> Join Challenge';

                                    joinForm.appendChild(joinButton);
                                    actionsContainer.appendChild(joinForm);
                                }
                            }
                        } else if (isCreator) {
                            // Creator actions for completed or deleted challenges
                            const reactivateForm = document.createElement('form');
                            reactivateForm.method = 'POST';
                            reactivateForm.action = `/challenges/${data.id}/reactivate`;

                            const reactivateButton = document.createElement('button');
                            reactivateButton.type = 'submit';
                            reactivateButton.className = 'btn btn-primary';
                            reactivateButton.innerHTML = '<i class="fas fa-redo-alt me-1"></i> Reactivate Challenge';

                            reactivateForm.appendChild(reactivateButton);
                            actionsContainer.appendChild(reactivateForm);
                        }
                    })
                    .catch(error => console.error('Error fetching challenge:', error));
            });
        });

        // Edit Challenge Modal
        const editChallengeButtons = document.querySelectorAll('.edit-challenge-btn');
        const editChallengeModal = document.getElementById('editChallengeModal');
        const editChallengeForm = document.getElementById('editChallengeForm');
        const updateChallengeBtn = document.getElementById('updateChallengeBtn');

        editChallengeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const challengeId = this.getAttribute('data-challenge-id');
                editChallengeForm.action = `/challenges/${challengeId}/update`;

                fetch(`/challenges/${challengeId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Fill form with challenge data
                        document.getElementById('editChallengeTitle').value = data.title;
                        document.getElementById('editChallengeDescription').value = data.description || '';
                        document.getElementById('editChallengeStatus').value = data.status;

                        // Format dates for datetime-local input
                        if (data.start_date) {
                            const startDate = new Date(data.start_date);
                            const formattedStartDate = startDate.toISOString().slice(0, 16);
                            document.getElementById('editChallengeStartDate').value = formattedStartDate;
                        } else {
                            document.getElementById('editChallengeStartDate').value = '';
                        }

                        if (data.end_date) {
                            const endDate = new Date(data.end_date);
                            const formattedEndDate = endDate.toISOString().slice(0, 16);
                            document.getElementById('editChallengeEndDate').value = formattedEndDate;
                        } else {
                            document.getElementById('editChallengeEndDate').value = '';
                        }

                        // Set participants
                        const checkboxes = document.querySelectorAll('.edit-participant-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = data.participants.some(participant => participant.id === parseInt(checkbox.value));
                        });
                    })
                    .catch(error => console.error('Error fetching challenge:', error));
            });
        });

        // Handle form submission via button click
        updateChallengeBtn.addEventListener('click', function() {
            editChallengeForm.submit();
        });

        // Delete Challenge Modal
        const deleteChallengeButtons = document.querySelectorAll('.delete-challenge-btn');
        const deleteChallengeModal = document.getElementById('deleteChallengeModal');
        const deleteChallengeForm = document.getElementById('deleteChallengeForm');

        deleteChallengeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const challengeId = this.getAttribute('data-challenge-id');
                const challengeItem = this.closest('.challenge-item');
                const challengeTitle = challengeItem.querySelector('.challenge-title').textContent;

                // Set form action and challenge title
                deleteChallengeForm.action = `/challenges/${challengeId}/delete`;
                document.getElementById('deleteChallengeTitle').textContent = challengeTitle;
            });
        });

        // Complete Challenge Modal
        const completeChallengeButtons = document.querySelectorAll('.complete-challenge-btn');
        const completeChallengeModal = document.getElementById('completeChallengeModal');
        const completeChallengeForm = document.getElementById('completeChallengeForm');

        completeChallengeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const challengeId = this.getAttribute('data-challenge-id');
                const challengeItem = this.closest('.challenge-item');
                const challengeTitle = challengeItem.querySelector('.challenge-title').textContent;

                // Set form action and challenge title
                completeChallengeForm.action = `/challenges/${challengeId}/complete`;
                document.getElementById('completeChallengeTitle').textContent = challengeTitle;
            });
        });
    });
</script>
{% endblock %}