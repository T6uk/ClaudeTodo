<!-- app/templates/games/play/memory/memory_match.html -->
{% extends "games/play/game_base.html" %}

{% block game_head %}
<style>
    .memory-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        max-width: 500px;
        margin: 0 auto;
        perspective: 1000px;
    }

    .memory-card {
        height: 100px;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.5s;
        cursor: pointer;
    }

    .memory-card.flipped {
        transform: rotateY(180deg);
    }

    .memory-card.matched {
        transform: rotateY(180deg);
    }

    .front-face, .back-face {
        width: 100%;
        height: 100%;
        padding: 10px;
        position: absolute;
        border-radius: 10px;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .front-face {
        background-color: var(--primary);
        transform: rotateY(180deg);
        font-size: 2rem;
        color: white;
    }

    .back-face {
        background-color: #ddd;
        color: #333;
        font-size: 1.5rem;
    }

    [data-bs-theme="dark"] .back-face {
        background-color: #343a40;
        color: #eee;
    }

    .moves-display {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
        text-align: center;
    }

    .timer-display {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block game_content %}
<div class="memory-game-container">
    <div class="d-flex justify-content-around mb-3">
        <div class="timer-display">
            Time: <span id="timer">0</span>s
        </div>
        <div class="moves-display">
            Moves: <span id="moves">0</span>
        </div>
    </div>

    <div class="memory-board" id="memoryBoard">
        <!-- Cards will be generated by JavaScript -->
    </div>
</div>
{% endblock %}

{% block game_controls %}
<button id="startButton" class="btn btn-primary me-2">
    <i class="fas fa-play me-1"></i> Start
</button>
<button id="resetButton" class="btn btn-secondary">
    <i class="fas fa-redo me-1"></i> Reset
</button>
{% endblock %}

{% block game_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Game variables
        let cards = [];
        let hasFlippedCard = false;
        let lockBoard = true;
        let firstCard, secondCard;
        let moves = 0;
        let matches = 0;
        let timer = 0;
        let timerInterval;
        let score = 0;

        const memoryBoard = document.getElementById('memoryBoard');
        const movesDisplay = document.getElementById('moves');
        const timerDisplay = document.getElementById('timer');
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');

        // Card symbols (using Font Awesome icons)
        const cardSymbols = [
            'fa-heart', 'fa-star', 'fa-bell', 'fa-gem',
            'fa-moon', 'fa-sun', 'fa-bolt', 'fa-fire'
        ];

        // Set up the board
        function setupBoard() {
            // Clear the board
            memoryBoard.innerHTML = '';

            // Create cards (pairs of symbols)
            cards = [...cardSymbols, ...cardSymbols];

            // Shuffle cards
            shuffleCards();

            // Create card elements
            cards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.classList.add('memory-card');
                card.dataset.symbol = symbol;

                const frontFace = document.createElement('div');
                frontFace.classList.add('front-face');
                frontFace.innerHTML = `<i class="fas ${symbol}"></i>`;

                const backFace = document.createElement('div');
                backFace.classList.add('back-face');
                backFace.innerHTML = `<i class="fas fa-question"></i>`;

                card.appendChild(frontFace);
                card.appendChild(backFace);

                card.addEventListener('click', flipCard);

                memoryBoard.appendChild(card);
            });
        }

        // Shuffle cards using Fisher-Yates algorithm
        function shuffleCards() {
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
        }

        // Flip card function
        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;

            this.classList.add('flipped');

            if (!hasFlippedCard) {
                // First card flipped
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            // Second card flipped
            secondCard = this;
            moves++;
            movesDisplay.textContent = moves;

            checkForMatch();
        }

        // Check if cards match
        function checkForMatch() {
            const isMatch = firstCard.dataset.symbol === secondCard.dataset.symbol;

            if (isMatch) {
                disableCards();
                matches++;

                // Check if all pairs have been matched
                if (matches === cardSymbols.length) {
                    endGameSuccess();
                }
            } else {
                unflipCards();
            }
        }

        // Disable matched cards
        function disableCards() {
            firstCard.classList.add('matched');
            secondCard.classList.add('matched');

            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);

            resetBoard();
        }

        // Unflip non-matching cards
        function unflipCards() {
            lockBoard = true;

            setTimeout(() => {
                firstCard.classList.remove('flipped');
                secondCard.classList.remove('flipped');

                resetBoard();
            }, 1000);
        }

        // Reset board after a turn
        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        // Start game
        function startGame() {
            // Reset game state
            hasFlippedCard = false;
            lockBoard = false;
            firstCard = null;
            secondCard = null;
            moves = 0;
            matches = 0;
            timer = 0;
            score = 0;

            // Reset displays
            movesDisplay.textContent = moves;
            timerDisplay.textContent = timer;
            updateScore(0);

            // Start timer
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timer++;
                timerDisplay.textContent = timer;
            }, 1000);

            // Enable cards
            document.querySelectorAll('.memory-card').forEach(card => {
                card.classList.remove('flipped', 'matched');
                card.addEventListener('click', flipCard);
            });
        }

        // End game (success)
        function endGameSuccess() {
            clearInterval(timerInterval);
            lockBoard = true;

            // Calculate score (based on moves and time)
            // Lower moves and time = higher score
            const baseScore = 10000;
            const movePenalty = moves * 50;
            const timePenalty = timer * 10;
            score = Math.max(0, baseScore - movePenalty - timePenalty);

            updateScore(score);

            // Show game end modal
            setTimeout(() => {
                let message = '';
                if (score > 8000) message = 'Excellent memory!';
                else if (score > 5000) message = 'Great job!';
                else message = 'Good effort!';

                endGame(score, message);
            }, 1000);
        }

        // Reset game
        function resetGame() {
            clearInterval(timerInterval);
            setupBoard();

            moves = 0;
            matches = 0;
            timer = 0;
            score = 0;

            movesDisplay.textContent = moves;
            timerDisplay.textContent = timer;
            updateScore(0);

            lockBoard = true;
        }

        // Event listeners
        startButton.addEventListener('click', function() {
            startGame();
        });

        resetButton.addEventListener('click', function() {
            resetGame();
        });

        // Initialize
        setupBoard();

        // Make resetGame function available globally
        window.resetGame = resetGame;
    });
</script>
{% endblock %}