{% extends "base.html" %}

{% block title %}Health Dashboard - Personal Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<style>
    .stat-card {
        border-radius: 0.5rem;
        transition: transform 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Health Dashboard</h2>
    <div>
        <a href="{{ url_for('health.list_records') }}" class="btn btn-outline-primary me-2">
            <i class="bi bi-list"></i> View All Records
        </a>
        <a href="{{ url_for('health.new_record') }}" class="btn btn-primary">
            <i class="bi bi-plus"></i> New Record
        </a>
    </div>
</div>

<!-- Health Stats Overview -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm h-100 stat-card bg-primary text-white">
            <div class="card-body text-center">
                <div class="stat-icon">
                    <i class="bi bi-droplet"></i>
                </div>
                <h5 class="card-title">Water Intake</h5>
                <h3 class="mb-0" id="waterAvg">Loading...</h3>
                <p class="card-text small">Average daily intake (L)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm h-100 stat-card bg-success text-white">
            <div class="card-body text-center">
                <div class="stat-icon">
                    <i class="bi bi-moon"></i>
                </div>
                <h5 class="card-title">Sleep</h5>
                <h3 class="mb-0" id="sleepAvg">Loading...</h3>
                <p class="card-text small">Average hours/night</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm h-100 stat-card bg-info text-white">
            <div class="card-body text-center">
                <div class="stat-icon">
                    <i class="bi bi-heart-pulse"></i>
                </div>
                <h5 class="card-title">Heart Rate</h5>
                <h3 class="mb-0" id="heartRateAvg">Loading...</h3>
                <p class="card-text small">Average BPM</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm h-100 stat-card bg-warning text-dark">
            <div class="card-body text-center">
                <div class="stat-icon">
                    <i class="bi bi-clipboard-pulse"></i>
                </div>
                <h5 class="card-title">Blood Pressure</h5>
                <h3 class="mb-0" id="bpAvg">Loading...</h3>
                <p class="card-text small">Average systolic/diastolic</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Weight Tracking</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Heart Rate Tracking</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="heartRateChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Sleep Duration</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="sleepChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Water Intake</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="waterChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Tips -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Health Tips</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-0">
            <h5><i class="bi bi-info-circle me-2"></i>Healthy Living Reminder</h5>
            <p>Remember to maintain a balanced diet, stay hydrated, get regular exercise, and prioritize sleep for optimal health.</p>
            <hr>
            <p class="mb-0">Track your health metrics consistently to identify patterns and make informed decisions about your well-being.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch health data from API
        fetch("{{ url_for('health.get_health_data') }}")
            .then(response => response.json())
            .then(data => {
                // Update summary stats
                updateSummaryStats(data);

                // Create charts
                createWeightChart(data);
                createHeartRateChart(data);
                createSleepChart(data);
                createWaterChart(data);
            })
            .catch(error => {
                console.error('Error fetching health data:', error);
            });
    });

    function updateSummaryStats(data) {
        // Calculate averages for summary cards
        let waterTotal = 0;
        let waterCount = 0;
        let sleepTotal = 0;
        let sleepCount = 0;
        let heartRateTotal = 0;
        let heartRateCount = 0;
        let bpSysTotal = 0;
        let bpDiaTotal = 0;
        let bpCount = 0;

        for (let i = 0; i < data.dates.length; i++) {
            if (data.water_intake[i]) {
                waterTotal += data.water_intake[i];
                waterCount++;
            }
            if (data.sleep_hours[i]) {
                sleepTotal += data.sleep_hours[i];
                sleepCount++;
            }
            if (data.heart_rate[i]) {
                heartRateTotal += data.heart_rate[i];
                heartRateCount++;
            }
            if (data.blood_pressure[i].systolic && data.blood_pressure[i].diastolic) {
                bpSysTotal += data.blood_pressure[i].systolic;
                bpDiaTotal += data.blood_pressure[i].diastolic;
                bpCount++;
            }
        }

        // Update UI with calculated averages
        document.getElementById('waterAvg').textContent = waterCount > 0 ? (waterTotal / waterCount).toFixed(1) : 'N/A';
        document.getElementById('sleepAvg').textContent = sleepCount > 0 ? (sleepTotal / sleepCount).toFixed(1) : 'N/A';
        document.getElementById('heartRateAvg').textContent = heartRateCount > 0 ? Math.round(heartRateTotal / heartRateCount) : 'N/A';

        const bpAvgSys = bpCount > 0 ? Math.round(bpSysTotal / bpCount) : 'N/A';
        const bpAvgDia = bpCount > 0 ? Math.round(bpDiaTotal / bpCount) : 'N/A';
        document.getElementById('bpAvg').textContent = bpCount > 0 ? `${bpAvgSys}/${bpAvgDia}` : 'N/A';
    }

    function createWeightChart(data) {
        const ctx = document.getElementById('weightChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Weight (kg)',
                    data: data.weight,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    function createHeartRateChart(data) {
        const ctx = document.getElementById('heartRateChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Heart Rate (BPM)',
                    data: data.heart_rate,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    function createSleepChart(data) {
        const ctx = document.getElementById('sleepChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Sleep Hours',
                    data: data.sleep_hours,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 12
                    }
                }
            }
        });
    }

    function createWaterChart(data) {
        const ctx = document.getElementById('waterChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Water Intake (L)',
                    data: data.water_intake,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>
{% endblock %}